---
title: "Solution to 2017 M3 Challenge"
output:
  html_notebook: default
  html_document: default
---
```{r}
#install.packages("readxl")
#install.packages("ggplot2")
#install.packages("reshape2")
library(readxl)
library(ggplot2)
library(reshape2)
```

This is an outline of a method of solution of the [2017 M3 Challenge](https://m3challenge.siam.org/sites/default/files/uploads/M3%20Challenge%20PROBLEM_2017_0.pdf).  The webpage with all the data is located [here](https://m3challenge.siam.org/node/336).

###Part 1 - Tides of Change
The goal is to build a mathematical model that will classify five national parks in terms of their risk of sea level change (high, medium, or low) over the next 10, 20, and 50 years.

To do so, we first look at the data [NPS_MeanSeaLevel](https://m3challenge.siam.org/sites/default/files/uploads/NPS_MeanSeaLevel_1.xlsx).  We look at the last sheet which contains the 20 years of mean sea level(MSL) data for the 5 national parks.

```{r}
library(readxl)
prob1 <- read_excel("data/NPS_MeanSeaLevel_1.xlsx", "20yr_Monthly_MSL", skip = 3)
colnames(prob1) <- c("Year", "Month", "Acadia", "Cape_Hatteras", "Kenai_Fords", "Olympic","Padre_Island")
prob1
```
It will first be helpful to plot the data.  We first give ourselves a column that measures the number of years since January 1997.
```{r}
prob1$years <- as.numeric(row.names(prob1))/12
prob1
```
Then we can look at a plot of Acadia
```{r}
ggplot(prob1, aes(years, Acadia)) + 
  geom_point(na.rm = TRUE, color = "blue") + 
  labs(title = "Mean Sea Level Trend for Acadia NP", x = "Years since 1/1/1997", y = "Mean Sea Level") +
  theme(plot.title = element_text(hjust = 0.5)) 

```
We can then add a linear fit to it.
```{r}
fit <- lm(Acadia ~ years, prob1)
summary(fit)

```

Notice that this linear fit has a positive slope, `r round(fit$coefficients[2] * 1000,2)` mm/year, and that with such a large t-value, we can say with confidence that it is greater than 0 (i.e. there is a trend of increasing mean sea level in Acadia over the last 20 years).  We can also reinforce this with a look at the 95% confidence interval for the slope in mm/year - (`r 1000*confint(fit, 'years', level=0.95)`).

We can then add this trend line to our plot.
```{r}
ggplot(prob1, aes(years, Acadia)) + 
  geom_point(na.rm = TRUE, color = "orange") + 
  labs(title = "Mean Sea Level Trend for Acadia NP", x = "Years since 1/1/1997", y = "Mean Sea Level") +
  theme(plot.title = element_text(hjust = 0.5)) +
  geom_smooth(method = 'lm', formula = y ~ x, na.rm = TRUE)
```

This slope is slightly different than the one given to us in the Excel file.

```{r}
npsMSL2 <- read_excel("Data/NPS_MeanSeaLevel_1.xlsx", sheet = "MSL_trend")
npsMSL2 <- npsMSL2[1:5,-1]
npsMSL2
```
To recreate their numbers, we need to look at all the historical data from the referenced site for [Station 8413320 ](https://tidesandcurrents.noaa.gov/sltrends/sltrends_station.shtml?stnid=8413320).
```{r}
acadia <- read.csv("https://tidesandcurrents.noaa.gov/sltrends/downloadMeanSeaLevelTrendsCSV.htm?stnid=8413320")
acadia$years <- as.numeric(row.names(acadia))/12
acadia <- acadia[1:1392,] #Removing everything after the previous year
acadia
```
We can plot this.
```{r}
ggplot(acadia, aes(years, Monthly_MSL)) + 
  geom_point(na.rm = TRUE, color = "orange") + 
  labs(title = "Mean Sea Level Trend for Acadia NP", x = "Years since 1/1/1900", y = "Mean Sea Level") +
  theme(plot.title = element_text(hjust = 0.5)) +
  geom_smooth(method = 'lm', formula = y ~ x, na.rm = TRUE)
```
We can look at the linear fit.
```{r}
fit2 <- lm(Monthly_MSL ~ years, acadia)
summary(fit2)

```
This gives a slope of `r round(1000*fit2$coefficients[2],2)` mm/year with a very large t-value.  Again, with certainty, we can say that the sea level is rising at this location.  We can look at the 95% confidence interval for the slope in mm/year - (`r 1000*confint(fit2, 'years', level=0.95)`).  This more closely mirrors the values they gave in the Excel sheet.

We will now look at all the stations.
```{r}
prob1Melt <- melt(prob1, id.vars=c("Year", "Month", "years"), variable.name = "National_Park", value.name = "MSL")
prob1Melt
```

```{r}
ggplot(prob1Melt, aes(years, MSL, color = National_Park)) + 
  geom_point(na.rm = TRUE) + 
  facet_grid(. ~ National_Park) + 
  labs(title = "Mean Sea Level Trend for Various National Parks", x = "Years since 1/1/1997", y = "Mean Sea Level") +
  theme(plot.title = element_text(hjust = 0.5), legend.position = "none") +
  geom_smooth(method = 'lm', formula = y ~ x, na.rm = TRUE, color = "gray40")

```

For further reference, there is a full list of colors for ggplot2 on this [site](http://sape.inf.usi.ch/quick-reference/ggplot2/colour).

Notice that the sea level change at Padre Island doesn't match the increase given in the excel sheet.  To understand this, we can look at the larger data set.

```{r}
#Keep just the data since 1970
mslFull <- acadia[-(1:840),]
mslFull$National_Park <- as.character(npsMSL2[2,2])
for (i in 3:ncol(npsMSL2) ) {
  dfTemp <- read.csv(paste("https://tidesandcurrents.noaa.gov/sltrends/downloadMeanSeaLevelTrendsCSV.htm?stnid=",as.character(as.integer(npsMSL2[1, i])),sep=""))
  dfTemp$National_Park <- as.character(npsMSL2[2,i])
  dfTemp$years <- as.numeric(row.names(dfTemp))/12
  #Keep just the data since 1970
  dfTemp <- dfTemp[-(1:840),]
  mslFull <- rbind(mslFull, dfTemp)
}

ggplot(mslFull, aes(years, Monthly_MSL, color = National_Park)) + 
  geom_point(na.rm = TRUE) + 
  facet_grid(. ~ National_Park) + 
  labs(title = "Mean Sea Level Trend for Various National Parks", x = "Years since 1/1/1970", y = "Mean Sea Level") +
  theme(plot.title = element_text(hjust = 0.5), legend.position = "none") +
  geom_smooth(method = 'lm', formula = y ~ x, na.rm = TRUE, color = "gray40")

```

